<?xml version="1.0" ?>
<project name="Windows Azure DistributionBundle" default="build" basedir=".">
    <property name="azure_distribution_bundle_version" value="v1.0.1" />
    <property name="azure_blob_version" value="v1.0" />
    <property name="kvs_version" value="v0.1" />
    <property name="shards_version" value="v1.0" />
    <property name="taskdemo_version" value="v1.1" />

    <target name="build">

        <delete dir="build" />
        <mkdir dir="build" />
        <mkdir dir="build/azure-distribution-bundle" />

        <download_github url="https://github.com/beberlei/AzureDistributionBundle/zipball/${azure_distribution_bundle_version}"
            target="WindowsAzure/DistributionBundle" />

        <download_github url="https://github.com/beberlei/azure-blob-storage/zipball/${azure_blob_version}"
            target="azure-blob-storage" />

        <download_github url="https://github.com/doctrine/KeyValueStore/zipball/${kvs_version}"
            target="doctrine-keyvaluestore" />

        <download_github url="https://github.com/doctrine/shards/zipball/${shards_version}"
            target="doctrine-shards" />

        <download_github url="https://github.com/beberlei/AzureTaskDemoBundle/zipball/${taskdemo_version}"
            target="WindowsAzure/TaskDemoBundle" />

        <copy file="build/azure-distribution-bundle/WindowsAzure/DistributionBundle/README.md" todir="build/azure-distribution-bundle" />
        <zip basedir="build/azure-distribution-bundle/" destfile="build/azure-distribution-bundle-${azure_distribution_bundle_version}.zip" />
    </target>

    <macrodef name="download_github">
        <attribute name="url" default="" />
        <attribute name="target" default="" />

        <sequential>
            <get src="@{url}" dest="build/temp.zip"/>
            <unzip src="build/temp.zip" dest="build/azure-distribution-bundle/@{target}" />

            <dirset id="github.dir" dir="build/azure-distribution-bundle/@{target}" includes="*"/>
            <local name="prop.github.dir"/>
            <property name="prop.github.dir" refid="github.dir"/>

            <move todir="build/azure-distribution-bundle/@{target}">
                <fileset dir="build/azure-distribution-bundle/@{target}/${prop.github.dir}">
                    <include name="**/**" />
                </fileset>
            </move>

            <delete dir="build/azure-distribution-bundle/@{target}/${prop.github.dir}" />
        </sequential>
    </macrodef>
</project>
